<div class="space-y-5 flash-in">
    {# Poker table with board revealed #}
    {% with board=board_visible, seats=scenario.seats, dealer_seat=scenario.dealer_seat,
            pot=(scenario.pot ~ ' BB'), situation=scenario.postflop_situation,
            bets=scenario.bets|default(none) %}
        {% include "partials/poker_table.html" %}
    {% endwith %}

    {# Street indicator #}
    <div class="text-center">
        <span class="text-xs font-semibold uppercase tracking-wider px-2 py-0.5 rounded
                     {% if street == 'flop' %}bg-emerald-900/40 text-emerald-400
                     {% elif street == 'turn' %}bg-blue-900/40 text-blue-400
                     {% else %}bg-purple-900/40 text-purple-400{% endif %}">
            {{ street }}
        </span>
    </div>

    {# Hand info #}
    <div class="text-center text-sm">
        <span class="text-gray-500 font-mono">{{ scenario.hand_key }}</span>
        <span class="mx-2 text-gray-700">|</span>
        <span class="text-gray-400">{{ scenario.bucket_label }}</span>
        <span class="mx-2 text-gray-700">|</span>
        <span class="text-xs text-gray-500 font-mono">{{ scenario.texture_label }}</span>
    </div>

    {% if feedback %}
    {# --- Result mode: inline feedback --- #}
    <div class="flex items-center justify-center gap-2 py-1">
        {% if feedback.is_primary %}
        <span class="text-emerald-400 text-2xl font-bold">&#10003;</span>
        <span class="text-emerald-400 font-semibold text-sm">Correct</span>
        {% elif feedback.is_acceptable %}
        <span class="text-amber-400 text-2xl font-bold">&#10003;</span>
        <span class="text-amber-400 font-semibold text-sm">Acceptable</span>
        {% else %}
        <span class="text-red-400 text-2xl font-bold">&#10007;</span>
        <span class="text-red-400 font-semibold text-sm">Incorrect</span>
        {% endif %}
    </div>
    <p class="text-center text-gray-400 text-xs">{{ feedback.explanation }}</p>

    {# Continue button â€” placed before educational content so user doesn't have to scroll #}
    <div class="text-center pt-2">
        {% if has_next_street %}
        <form hx-post="/api/play/next_street" hx-target="#scenario-zone" hx-swap="innerHTML">
            <input type="hidden" name="streak" value="{{ streak }}">
            {% if filter_position %}<input type="hidden" name="filter_position" value="{{ filter_position }}">{% endif %}
            <input type="hidden" name="hand" value='{{ scenario.hand | tojson }}'>
            <input type="hidden" name="hand_key" value="{{ scenario.hand_key }}">
            <input type="hidden" name="board_full" value='{{ board_full | tojson }}'>
            <input type="hidden" name="street" value="{{ street }}">
            <input type="hidden" name="position" value="{{ scenario.position }}">
            <input type="hidden" name="postflop_position" value="{{ scenario.postflop_position }}">
            <input type="hidden" name="seats" value='{{ scenario.seats | tojson }}'>
            <input type="hidden" name="dealer_seat" value="{{ scenario.dealer_seat }}">
            <input type="hidden" name="pot" value="{{ scenario.pot }}">
            <button type="submit"
                    class="px-8 py-3 bg-emerald-800 hover:bg-emerald-700 rounded-lg
                           font-semibold transition-all text-sm">
                {% if street == 'flop' %}See the Turn{% elif street == 'turn' %}See the River{% endif %} &rarr;
            </button>
        </form>
        {% else %}
        <form hx-post="/api/play/next" hx-target="#scenario-zone" hx-swap="innerHTML">
            <input type="hidden" name="streak" value="{{ streak }}">
            {% if filter_position %}<input type="hidden" name="filter_position" value="{{ filter_position }}">{% endif %}
            <button type="submit"
                    class="px-8 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg
                           font-semibold transition-all text-sm">
                Next Hand &rarr;
            </button>
        </form>
        {% endif %}
    </div>

    {# OOB streak update #}
    <span id="streak-val" hx-swap-oob="innerHTML">{{ streak }}</span>

    {# Range vs Range analysis #}
    {% include "partials/range_vs_range.html" %}

    {# Explanation depth toggle #}
    {% include "partials/explanation.html" %}

    {# Strategy bars (revealed after answer) #}
    <div class="bg-gray-900/60 rounded-xl p-4 space-y-3">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">
            Your hand: {{ feedback.bucket_label }}
        </h3>
        <div class="space-y-1.5">
            {% for action, prob in feedback.strategy.items() | sort(attribute='1', reverse=true) %}
            <div class="flex items-center gap-3">
                <span class="text-sm text-gray-400 w-20">
                    {{ feedback.action_labels.get(action, action) }}
                </span>
                <div class="flex-1 bg-gray-800 rounded-full h-2.5 overflow-hidden">
                    <div class="h-full rounded-full
                                {% if action in feedback.correct_actions %}bg-emerald-500{% else %}bg-gray-600{% endif %}"
                         style="width: {{ (prob * 100) | int }}%"></div>
                </div>
                <span class="text-xs text-gray-500 w-10 text-right font-mono">{{ (prob * 100) | int }}%</span>
            </div>
            {% endfor %}
        </div>
    </div>

    {# Range breakdown (revealed after answer) #}
    {% if feedback.range_breakdown %}
    <div class="bg-gray-900/60 rounded-xl p-4">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
            Range Strategy ({{ feedback.texture_label }}, {{ scenario.postflop_position }})
        </h3>
        <div class="space-y-1 text-sm">
            {% for bucket, strat in feedback.range_breakdown.items() %}
            <details class="bucket-details">
                <summary class="flex items-center gap-2 cursor-pointer py-0.5 hover:bg-gray-800/40 rounded px-1 -mx-1">
                    <span class="text-gray-400 w-24 shrink-0 font-mono text-xs
                                {% if bucket == feedback.bucket %}text-yellow-400 font-bold{% endif %}">
                        {{ bucket }}
                    </span>
                    <div class="flex-1 flex gap-1 flex-wrap">
                        {% for action, prob in strat.items() | sort(attribute='1', reverse=true) %}
                        {% if prob > 0 %}
                        <span class="text-xs px-1.5 py-0.5 rounded
                                    {% if 'bet' in action or action == 'raise' %}bg-emerald-900/60 text-emerald-400
                                    {% elif action == 'call' %}bg-blue-900/60 text-blue-400
                                    {% elif action == 'check' %}bg-gray-800 text-gray-400
                                    {% else %}bg-gray-800 text-gray-500{% endif %}">
                            {{ feedback.action_labels.get(action, action) }} {{ (prob * 100) | int }}%
                        </span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </summary>
                {% if feedback.bucket_examples and feedback.bucket_examples[bucket] %}
                <div class="ml-1 pl-4 border-l border-gray-800 mt-1 mb-2">
                    <div class="flex flex-wrap gap-1.5">
                        {% for ex in feedback.bucket_examples[bucket] %}
                        <span class="text-xs text-gray-500 bg-gray-800/60 px-1.5 py-0.5 rounded">{{ ex }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </details>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    {# --- Decision mode: action buttons, no ranges --- #}
    <form hx-post="/api/play/postflop_answer" hx-target="#scenario-zone" hx-swap="innerHTML">
        {% if filter_position %}<input type="hidden" name="filter_position" value="{{ filter_position }}">{% endif %}
        <input type="hidden" name="hand_key" value="{{ scenario.hand_key }}">
        <input type="hidden" name="postflop_position" value="{{ scenario.postflop_position }}">
        <input type="hidden" name="bucket" value="{{ scenario.bucket }}">
        <input type="hidden" name="bucket_label" value="{{ scenario.bucket_label }}">
        <input type="hidden" name="texture" value="{{ scenario.texture }}">
        <input type="hidden" name="texture_label" value="{{ scenario.texture_label }}">
        <input type="hidden" name="strategy" value='{{ scenario.strategy | tojson }}'>
        <input type="hidden" name="correct_actions" value='{{ scenario.correct_actions | tojson }}'>
        <input type="hidden" name="postflop_action_labels" value='{{ scenario.postflop_action_labels | tojson }}'>
        <input type="hidden" name="range_breakdown" value='{{ scenario.range_breakdown | tojson }}'>
        <input type="hidden" name="streak" value="{{ streak }}">
        {# Carry state for re-render + street progression #}
        <input type="hidden" name="hand" value='{{ scenario.hand | tojson }}'>
        <input type="hidden" name="board_full" value='{{ board_full | tojson }}'>
        <input type="hidden" name="board_visible" value='{{ board_visible | tojson }}'>
        <input type="hidden" name="street" value="{{ street }}">
        <input type="hidden" name="position" value="{{ scenario.position }}">
        <input type="hidden" name="seats" value='{{ scenario.seats | tojson }}'>
        <input type="hidden" name="dealer_seat" value="{{ scenario.dealer_seat }}">
        <input type="hidden" name="pot" value="{{ scenario.pot }}">
        <input type="hidden" name="postflop_situation" value="{{ scenario.postflop_situation }}">
        <input type="hidden" name="facing_bet" value="{{ scenario.facing_bet|default('False') }}">

        <div class="flex justify-center gap-2 flex-wrap">
            {% for action in scenario.postflop_actions %}
            <button type="submit" name="action" value="{{ action }}"
                    class="px-5 py-2.5 rounded-lg font-semibold transition-all text-sm
                    {% if action == 'check' %}
                        bg-gray-700 hover:bg-gray-600
                    {% elif action == 'fold' %}
                        bg-gray-700 hover:bg-gray-600
                    {% elif action == 'call' %}
                        bg-blue-700 hover:bg-blue-600
                    {% elif action == 'bet_s' %}
                        bg-emerald-800 hover:bg-emerald-700
                    {% elif action == 'bet_m' %}
                        bg-emerald-700 hover:bg-emerald-600
                    {% elif action == 'bet_l' or action == 'raise' %}
                        bg-emerald-600 hover:bg-emerald-500
                    {% endif %}">
                {{ scenario.postflop_action_labels[action] }}
            </button>
            {% endfor %}
        </div>
    </form>
    {% endif %}
</div>
